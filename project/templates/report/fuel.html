{% extends 'template.html' %}
{% load static %}

{% block navigation %}
<div class="container-fluid">
    <a class="navbar-brand" href="{% url 'home_index' %}">
        <img src="{% static 'img/user_icon.svg' %}" alt="Avatar Logo" style="width:40px;" class="rounded-pill">
        <span class="navbar-text">{{ wialon_user }}</span>
    </a>

    <div class="collapse navbar-collapse" id="mynavbar">
        <ul class="navbar-nav me-auto">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'home_index' %}">Link</a></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'home_index' %}">Link</a></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'home_index' %}">Link</a></a>
            </li>
        </ul>
        <form class="d-flex">
            <input class="form-control me-2" type="text" placeholder="Поиск">
            <button class="btn btn-primary" type="button">Поиск</button>
        </form>
    </div>
</div>
{% endblock navigation %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex flex-wrap justify-content-center gap-3">
        <div class="card text-white bg-primary mb-3" style="max-width: 10rem; max-height: 8rem;">
            <div class="card-header">Залито топлива</div>
            <div class="card-body">
                <h3 class="card-title text-center fs-3">0</h3>
            </div>
        </div>
        <div class="card text-white bg-danger mb-3" style="max-width: 10rem; max-height: 8rem;">
            <div class="card-header">Слито топлива</div>
            <div class="card-body">
                <h3 class="card-title text-center fs-3">{{ fuel_theft }}</h3>
            </div>
        </div>
    </div>
</div>

<div class="container mt-3 mb-5">
    <div class="d-flex justify-content-between align-items-center">
        <div class="btn-group" role="group" aria-label="Basic outlined example">
            <button type="button" class="btn btn-outline-primary" title="За вчера с 00:00 до 23:59">
                <a class="nav-link" href="{% url 'fuel_report' object_id %}">Вчера</a>
            </button>
            <button type="button" class="btn btn-outline-primary" title="За сегодня с 00:00 до настоящего момента">
                <a class="nav-link" href="{% url 'fuel_report' object_id %}">Сегодня</a>
            </button>
            <button type="button" class="btn btn-outline-primary" title="За прошлую неделю">
                <a class="nav-link" href="{% url 'fuel_report' object_id %}">Неделя</a>
            </button>
            <button type="button" class="btn btn-outline-primary" title="За прошлый месяц">
                <a class="nav-link" href="{% url 'fuel_report' object_id %}">Месяц</a>
            </button>
        </div>

        <div class="d-flex align-items-center">
            <label for="startDate" class="mr-3" style="margin-right: 1vw;">Начало: </label>
            <input type="date" id="startDate" class="form-control mr-3" style="margin-right: 1vw;">
            <label for="endDate" class="mr-3" style="margin-right: 1vw;">Конец: </label>
            <input type="date" id="endDate" class="form-control mr-3" style="margin-right: 0.5vw;">
            <button id="searchButton" class="btn btn-primary">Поиск</button>
        </div>
    </div>

    <h2>График топлива</h2>
    <div style="position: relative;">
        <div class="form-check">
            <label class="form-check-label">
                <input class="form-check-input" type="checkbox" id="markerFilter" checked>
                Показать маркеры
            </label>
        </div>
        <canvas id="fuelChart" width="800" height="300"></canvas>
    </div>
</div>

<table class="table table-danger">
    <thead>
        <tr>
            <th scope="col">Время слива</th>
            <th scope="col">Топливо до</th>
            <th scope="col">Топливо после</th>
            <th scope="col">Слито топлива</th>
        </tr>
    </thead>
    <tbody>
        {% for item in data_for_table %}
            <tr>
                <th scope="row">{{ item.time_of_theft }}</th>
                <td>{{ item.fuel_before_theft }}</td>
                <td>{{ item.fuel_during_theft }}</td>
                <td>{{ item.fuel_difference }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}

{% block js_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const data = JSON.parse('{{ data_for_chart|safe }}');

        const dataset = data.datasets['0'];
        const xData = dataset.data.x.map(ts => new Date(ts * 1000));
        const yData = dataset.data.y;

        // Marker data
        const markers = data.markers;

        function formatTimeLabels(value, index, values) {
            const date = new Date(value);
            const hours = date.getHours().toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${hours}:00 ${day}-${month}`;
        }

        const ctx = document.getElementById('fuelChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: xData,
                datasets: [{
                    label: dataset.name,
                    backgroundColor: `#${dataset.color.toString(16).padStart(6, '0')}`,
                    borderColor: `#${dataset.color.toString(16).padStart(6, '0')}`,
                    data: yData,
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        ticks: {
                            callback: function(value, index, values) {
                                return formatTimeLabels(value, index, values);
                            },
                            stepSize: 12 * 3600 * 1000 // Интервал 12 часов
                        },
                    },
                    y: {
                        ticks: {
                            stepSize: 5 // Интервал 5 единиц
                        },
                        title: {
                            display: true,
                            text: 'Уровень топлива, литры'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(tooltipItems, data) {
                                const date = new Date(tooltipItems[0].parsed.x);
                                const hours = date.getHours().toString().padStart(2, '0');
                                const day = date.getDate().toString().padStart(2, '0');
                                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                                return `${hours}:00 ${day}-${month}`;
                            },
                            label: function(tooltipItem) {
                                return `Уровень топлива: ${tooltipItem.raw}`;
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });

        const markerIcons = {
            8: "{% static 'img/fuel.png' %}",
            256: "{% static 'img/fuel_theft.png' %}",
            // Add more types and their respective icons
        };

        function addMarkers() {
            // Clear existing markers
            document.querySelectorAll('.chart-marker').forEach(el => el.remove());

            markers.forEach(marker => {
                const index = xData.findIndex(date => date.getTime() / 1000 === marker.x[0]);
                if (index !== -1) {
                    const iconUrl = markerIcons[marker.type] || "{% static 'img/error.svg' %}";
                    const markerElement = new Image();
                    markerElement.src = iconUrl;
                    markerElement.style.position = 'absolute';
                    markerElement.style.width = '20px';
                    markerElement.style.height = '20px';
                    markerElement.style.top = '10vh'; // Adjust as needed
                    markerElement.classList.add('chart-marker');

                    const canvasPosition = chart.getDatasetMeta(0).data[index].getCenterPoint();
                    markerElement.style.left = canvasPosition.x + 'px';
                    markerElement.setAttribute('data-index', index);
                    document.getElementById('fuelChart').parentNode.appendChild(markerElement);
                }
            });
        }

        // Adjust marker positions on resize
        window.addEventListener('resize', addMarkers);

        // Filter markers based on checkbox
        document.getElementById('markerFilter').addEventListener('change', function() {
            const markers = document.querySelectorAll('.chart-marker');
            markers.forEach(marker => {
                marker.style.display = this.checked ? 'block' : 'none';
            });
        });

        // Initial marker addition
        addMarkers();

        chart.update();

        // Date range filter functionality
        function toUnixTimestamp(dateStr) {
            return Math.floor(new Date(dateStr).getTime() / 1000);
        }

        document.getElementById('searchButton').addEventListener('click', function() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const endDateTime = new Date(`${endDate}T23:59:59`).toUTCString();


            if (!startDate || !endDate) {
                alert("Пожалуйста, выберите обе даты.");
                return;
            }

            const startUnix = toUnixTimestamp(startDate);
            const endUnix = toUnixTimestamp(endDateTime);

            // Perform AJAX request or redirect with date parameters in UNIX format
            const url = "{% url 'fuel_report' object_id %}?flag=" + "0x00" + "&start=" + startUnix + "&end=" + endUnix;
            window.location.href = url;
        });
    });
</script>
{% endblock js_scripts %}
